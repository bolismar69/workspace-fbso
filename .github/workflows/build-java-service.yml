name: Reusable Build Java Service

# Template para build e push de serviços Java em monorepo.
# Reutilizável via `workflow_call`.

on:
  workflow_call:
    inputs:
      services:
        description: 'JSON array de objetos {"path":"...","goals":"..."} com os serviços a processar'
        required: true
        type: string
    secrets:
      DOCKERHUB_USERNAME:
        required: true
      DOCKERHUB_TOKEN:
        required: true

jobs:
  build_and_push:
    name: "Build e Push Java (${{ matrix.path }})"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(inputs.services) }}

    steps:
      - name: Checkout do repositório
        id: checkout
        uses: actions/checkout@v4

      - name: Carregar variáveis de ambiente compartilhadas (valida e exporta para passos seguintes)
        id: load_shared_env
        run: |
          set -euo pipefail
          if [ ! -f .github/docker.env ]; then
            echo ".github/docker.env não encontrado" >&2
            exit 1
          fi
          if [ ! -f .github/docker.java.env ]; then
            echo ".github/docker.java.env não encontrado" >&2
            exit 1
          fi
          while IFS= read -r line || [ -n "$line" ]; do
            case "$line" in
              ''|#*) continue ;;
              *) echo "$line" >> $GITHUB_ENV ;;
            esac
          done < .github/docker.env
          while IFS= read -r line || [ -n "$line" ]; do
            case "$line" in
              ''|#*) continue ;;
              *) echo "$line" >> $GITHUB_ENV ;;
            esac
          done < .github/docker.java.env

      - name: Configurar Java
        id: setup_java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Definir caminho sanitizado
        id: sanitize_path
        run: |
          set -euo pipefail
          # substitui / por - e usa basename para evitar caminhos longos
          SANITIZED=$(basename "${{ matrix.path }}" | tr '/' '-')
          echo "SANITIZED_PATH=$SANITIZED" >> $GITHUB_ENV

      - name: Cache do Maven
        id: cache_maven
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ env.SANITIZED_PATH }}-${{ hashFiles(format('{0}/**/pom.xml', matrix.path)) }}
          restore-keys: ${{ runner.os }}-maven-

      - name: Build do serviço com Maven (usa mvnw quando disponível)
        id: maven_build
        run: |
          set -euo pipefail
          cd ${{ matrix.path }}
          if [ -x ./mvnw ]; then
            ./mvnw ${{ matrix.goals }}
          else
            mvn ${{ matrix.goals }}
          fi

      - name: Validar artefato gerado
        id: validate_artifact
        run: |
          set -euo pipefail
          cd ${{ matrix.path }}
          if compgen -G "target/*.jar" > /dev/null; then
            echo "OK - artifact JAR encontrado"
          elif [ -d target ] && [ "$(ls -A target)" ]; then
            echo "OK - diretório target contém arquivos"
          else
            echo "Artifact ausente em ${{ matrix.path }}" >&2
            ls -la || true
            exit 1
          fi

      - name: Preparar Docker Buildx
        id: setup_buildx
        uses: docker/setup-buildx-action@v2

      - name: Login no registry Docker
        id: docker_login
        uses: docker/login-action@v2
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Definir IMAGE_NAME e IMAGE_TAG
        id: define_image
        run: |
          set -euo pipefail
          IMAGE_NAME=$(basename "${{ matrix.path }}" | tr '/' '-')
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          echo "IMAGE_TAG=${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_ORG }}/$IMAGE_NAME:${{ env.DOCKER_TAG_PREFIX }}-${{ github.sha }}" >> $GITHUB_ENV

      - name: Build & Push com build-push-action
        id: buildpush
        uses: docker/build-push-action@v4
        with:
          context: ${{ matrix.path }}
          push: true
          tags: ${{ env.IMAGE_TAG }}
          build-args: |
            IMAGE_TO_BUILD=${{ env.IMAGE_TO_BUILD_STANDARD }}
            IMAGE_TO_RUNTIME=${{ env.IMAGE_TO_RUNTIME_JVM }}
            PORT_TO_EXPOSE=${{ env.PORT_TO_EXPOSE }}
