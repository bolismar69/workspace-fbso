name: Reusable Build Java Service

# Template para build e push de serviços Java em monorepo.
# Reutilizável via `workflow_call`.

on:
  workflow_call:
    inputs:
      services:
        description: 'JSON array de objetos {"path":"...","goals":"..."} com os serviços a processar'
        required: true
        type: string
    secrets:
      DOCKERHUB_USERNAME:
        required: true
      DOCKERHUB_TOKEN:
        required: true

jobs:
  build_and_push:
    name: "Build e Push Java (${{ matrix.path }})"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(inputs.services) }}

    steps:
      - name: Checkout do repositório
        id: checkout
        uses: actions/checkout@v4

      - name: Carregar variáveis de ambiente compartilhadas (valida e exporta para passos seguintes)
        id: load_shared_env
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            function loadEnvFile(filePath) {
              if (!fs.existsSync(filePath)) {
                throw new Error(`${filePath} não encontrado`);
              }

              const raw = fs.readFileSync(filePath, 'utf8');
              const lines = raw.split('\n');

              for (const originalLine of lines) {
                const line = (originalLine ?? '').replace(/\r$/, '');
                const trimmed = line.trim();
                if (!trimmed || trimmed.startsWith('#')) continue;

                const eq = trimmed.indexOf('=');
                if (eq <= 0) {
                  core.warning(`Linha inválida ignorada em ${filePath}: ${trimmed}`);
                  continue;
                }

                const key = trimmed.slice(0, eq).trim();
                let value = trimmed.slice(eq + 1);

                // Pequena compatibilidade com placeholder comum do bash
                const sha = process.env.GITHUB_SHA || context.sha;
                value = value.replace(/\$\{GITHUB_SHA:0:7\}/g, sha.substring(0, 7));
                value = value.replace(/\$\{GITHUB_SHA\}/g, sha);

                core.exportVariable(key, value);
              }
            }

            loadEnvFile('.github/docker.env');
            loadEnvFile('.github/docker.java.env');

      - name: Configurar Java
        id: setup_java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Definir caminho sanitizado
        id: sanitize_path
        uses: actions/github-script@v7
        env:
          MATRIX_PATH: ${{ matrix.path }}
        with:
          script: |
            const matrixPath = (process.env.MATRIX_PATH ?? '').toString();
            if (!matrixPath) throw new Error('MATRIX_PATH vazio');

            const parts = matrixPath.split('/').filter(Boolean);
            const baseName = parts[parts.length - 1] || matrixPath;
            const sanitized = baseName.replace(/\//g, '-');

            core.exportVariable('SANITIZED_PATH', sanitized);

      - name: Cache do Maven
        id: cache_maven
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ env.SANITIZED_PATH }}-${{ hashFiles(format('{0}/**/pom.xml', matrix.path)) }}
          restore-keys: ${{ runner.os }}-maven-

      - name: Build do serviço com Maven (usa mvnw quando disponível)
        id: maven_build
        run: |
          set -euo pipefail
          cd ${{ matrix.path }}
          if [ -x ./mvnw ]; then
            ./mvnw ${{ matrix.goals }}
          else
            mvn ${{ matrix.goals }}
          fi

      - name: Validar artefato gerado
        id: validate_artifact
        run: |
          set -euo pipefail
          cd ${{ matrix.path }}
          if compgen -G "target/*.jar" > /dev/null; then
            echo "OK - artifact JAR encontrado"
          elif [ -d target ] && [ "$(ls -A target)" ]; then
            echo "OK - diretório target contém arquivos"
          else
            echo "Artifact ausente em ${{ matrix.path }}" >&2
            ls -la || true
            exit 1
          fi

      - name: Preparar Docker Buildx
        id: setup_buildx
        uses: docker/setup-buildx-action@v2

      - name: Login no registry Docker
        id: docker_login
        uses: docker/login-action@v2
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Definir IMAGE_NAME e IMAGE_TAG
        id: define_image
        uses: actions/github-script@v7
        env:
          MATRIX_PATH: ${{ matrix.path }}
          DOCKER_REGISTRY: ${{ env.DOCKER_REGISTRY }}
          DOCKER_ORG: ${{ env.DOCKER_ORG }}
          DOCKER_TAG_PREFIX: ${{ env.DOCKER_TAG_PREFIX }}
          GITHUB_SHA: ${{ github.sha }}
        with:
          script: |
            const matrixPath = (process.env.MATRIX_PATH ?? '').toString();
            if (!matrixPath) throw new Error('MATRIX_PATH vazio');

            const parts = matrixPath.split('/').filter(Boolean);
            const imageName = parts[parts.length - 1] || matrixPath;
            core.exportVariable('IMAGE_NAME', imageName);

            const registry = (process.env.DOCKER_REGISTRY ?? '').toString();
            const org = (process.env.DOCKER_ORG ?? '').toString();
            const prefix = (process.env.DOCKER_TAG_PREFIX ?? 'ci').toString();
            const sha = (process.env.GITHUB_SHA ?? context.sha).toString();

            if (!registry || !org) {
              throw new Error('DOCKER_REGISTRY/DOCKER_ORG não definidos');
            }

            const imageTag = `${registry}/${org}/${imageName}:${prefix}-${sha}`;
            core.exportVariable('IMAGE_TAG', imageTag);

      - name: Build & Push com build-push-action
        id: buildpush
        uses: docker/build-push-action@v4
        with:
          context: ${{ matrix.path }}
          push: true
          tags: ${{ env.IMAGE_TAG }}
          build-args: |
            IMAGE_TO_BUILD=${{ env.IMAGE_TO_BUILD_STANDARD }}
            IMAGE_TO_RUNTIME=${{ env.IMAGE_TO_RUNTIME_JVM }}
            PORT_TO_EXPOSE=${{ env.PORT_TO_EXPOSE }}
