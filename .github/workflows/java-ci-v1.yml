# .github/workflows/java-ci.yml
name: Java CI Dispatcher

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/java/**'
      - 'architecture/blueprints/java/**'
  pull_request:
    paths:
      - 'backend/java/**'
      - 'architecture/blueprints/java/**'

jobs:
  detect-and-dispatch:
    name: Detect Java Changes and Dispatch Jobs
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect affected services
        id: set-matrix
        run: |
          CHANGED_PATHS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^backend/java/' || true)

          SERVICES=""
          for path in $CHANGED_PATHS; do
            root=$(echo "$path" | cut -d '/' -f 1-5)
            if [[ ! "$SERVICES" == *"$root"* ]]; then
              SERVICES="$SERVICES\"$root\",\n"
            fi
          done

          MATRIX_JSON="{\"include\": [$(echo -e $SERVICES | sed 's/,\n$//')]}"
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT

  build-java-services:
    name: Build Java Services
    needs: detect-and-dispatch
    if: needs.detect-and-dispatch.outputs.matrix != '{}'
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-and-dispatch.outputs.matrix) }}
    uses: ./.github/workflows/callables/build-java-service.yml
    with:
      service-path: ${{ matrix.include }}
      maven-goals: clean install -DskipTests
