# syntax=docker/dockerfile:1.7
ARG APP_PORT=8080
ARG IMAGE_TO_BUILD=ghcr.io/graalvm/native-image-community:latest
ARG IMAGE_TO_RUNTIME=gcr.io/distroless/cc-debian12

# Builder GraalVM Native
# ARG SPRING_NATIVE_BUILDER=ghcr.io/graalvm/native-image-community:latest
# FROM ${SPRING_NATIVE_BUILDER} AS build
FROM ${IMAGE_TO_BUILD} AS build

# novo: caminho do serviço dentro do monorepo
ARG SERVICE_PATH=.

WORKDIR /workspace

# importante: com context na raiz, copia o repo inteiro
COPY . .

# agora entra na pasta do serviço para executar o mvnw/pom daquele módulo
WORKDIR /workspace/${SERVICE_PATH}

# Build Native (wrapper obrigatório)
RUN --mount=type=cache,target=/root/.m2 \
  --mount=type=cache,target=/root/.gradle \
  set -eux; \
  if [ -x ./mvnw ]; then \
    # GraalVM Build Tools (plugin org.graalvm.buildtools:native-maven-plugin)
    # Nota: evitar depender de profile 'native' no serviço; o goal explícito é mais robusto.
    ./mvnw -q -DskipTests -Ddependency-check.skip=true native:compile; \
  elif [ -x ./gradlew ]; then \
    # Gradle (com Spring Native plugin configurado)
    ./gradlew build nativeCompile; \
  else \
    echo "ERRO: Padronize mvnw/gradlew no repo." && exit 1; \
  fi

# Normalize binário -> /workspace/app
# (Quando a org padronizar: troque este bloco por um COPY direto de ./out/app)
RUN set -eux; \
  BIN=""; \
  # Maven (varia conforme plugin/config do projeto)
  if [ -d target ]; then BIN="$(find target -maxdepth 6 -type f -perm -111 | head -n 1 || true)"; fi; \
  # Gradle (com nativeCompile costuma cair em build/native/nativeCompile/)
  if [ -z "$BIN" ] && [ -d build ]; then BIN="$(find build -maxdepth 8 -type f -perm -111 | head -n 1 || true)"; fi; \
  if [ -z "$BIN" ]; then \
    echo "ERRO: Binário nativo não encontrado. Padronize a saída do Spring Native (recomendado: ./out/app)." && exit 1; \
  fi; \
  cp "$BIN" /workspace/app; \
  chmod +x /workspace/app

########################
# Runtime Native
########################
# FROM gcr.io/distroless/cc-debian12 AS runtime
FROM ${IMAGE_TO_RUNTIME} AS runtime
ARG APP_PORT
WORKDIR /app
COPY --from=build /workspace/app /app/app
USER 10001
EXPOSE ${APP_PORT}
ENTRYPOINT ["/app/app"]
